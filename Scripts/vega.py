import json, base64, binascii

class Vega:
    def __init__(self):
        self.vega64 = {
            "hex": "b6020801005c00e1060000ee2b00001b004800000080a90300f0490200power0008000000000000000000000000000002015c004f02460294009e01be0028017a008c00bc0100000000720200009000a8026d0143019701f049020071020202000000000000080000000000000005000700030005000000000000000108P0cvP1cvP2cvP3cvP4cvP5cvP6cvP7cv0101P3mv01018403000860ea00000040190100018038010002dc4a010003905f010004007701000590910100066cb00100070108P0cf00000080000000000000P1cf00010000000000000000P2cf00020000000000000000P3cf00030000000000000000P4cf00040000000000000000P5cf00050000000001000000P6cf00060000000001000000P7cf00070000000001000000000560ea00000040190100008038010000dc4a010000905f0100000008286e0000002cc9000001f80b0100028038010003905f010004f491010005d0b0010006c0d401000700086c39000000245e000001fc85000002acbc00000334d0000004686e0100050897010006eca30100070001683c0100000104P0mf00000000P1mf00000000P2mf00020000P3mf000400000108009885000040b5000060ea000050c300000180bb000060ea0000940b010050c300000200e10000940b01004019010050c300000378ff0000401901008826010050c300000440190100803801008038010050c300000580380100dc4a0100dc4a010050c30000060077010000770100905f010050c300000790910100909101000077010050c300000118000000000000000bsenFanfreeFandownFantempLine0a0054039001900190019001900190019001000000000002minFanmaxFan07dc00dc00dc002c010000590069004a004a005f007300730064004000909297609600905500000000000000000000000000000000000202d4300000021060ea00000210",
            "defaults": {
                "P0cv": 800,
                "P1cv": 900,
                "P2cv": 950,
                "P3cv": 1000,
                "P4cv": 1050,
                "P5cv": 1100,
                "P6cv": 1150,
                "P7cv": 1200,
                "P0cf": 852,
                "P1cf": 991,
                "P2cf": 1084,
                "P3cf": 1138,
                "P4cf": 1200,
                "P5cf": 1401,
                "P6cf": 1536,
                "P7cf": 1630,
                "P3mv": 1350,
                "P0mf": 167,
                "P1mf": 500,
                "P2mf": 800,
                "P3mf": 945,
                "freeFan": 2400,
                "downFan": 2400,
                "minFan": 400,
                "maxFan": 4900,
                "senFan": 4836,
                "tempLine": 70,
                "power": 50
            }
        }
        self.vega56 = {
            "hex": "a7020801005c00ef0600000e2c00001b004800000080a90300f0490200power0008000000000000000000000000000002015c004002370294008f01b4001e017a008c00ad010000000063020000900099025e01340188016836020071020202000000000000080000000000000005000700030005000000000000000108P0cvP1cvP2cvP3cvP4cvP5cvP6cvP7cv0101P3mv01018403000660ea0000004019010001dc4a010002007701000390910100056cb00100070108P0cf00000080000000000000P1cf00010000000000000000P2cf00020000000000000000P3cf00030000000000000000P4cf00040000000000000000P5cf00050000000001000000P6cf00060000000001000000P7cf00070000000001000000000460ea0000004019010000dc4a010000905f0100000008286e0000002cc9000001f80b0100028038010003905f010004f491010005d0b0010006c0d401000700086c39000000245e000001fc85000002acbc00000334d0000004686e0100050897010006eca30100070001683c0100000104P0mf00000000P1mf00000000P2mf00010000P3mf000200000108009885000040b5000060ea000050c300000180bb000060ea0000940b010050c300000278ff000040190100b427010050c3000003b4270100dc4a0100dc4a010050c300000480380100905f0100dc4a010050c3000005dc4a010000770100905f010050c30000060077010000770100905f010050c300000700770100909101000077010050c300000118000000000000000bsenFanfreeFandownFantempLine0a0054039001900190019001900190019001000000000002minFanmaxFan07a500a500a5002c010000590069004a004a005f007300730064004000909297609600905500000000000000000000000000000000000202d4300000021060ea00000210",
            "defaults": {
                "P7cf": 1590, 
                "P2mf": 700, 
                "P5cf": 1474, 
                "tempLine": 75, 
                "P2cf": 1138, 
                "P3mf": 800, 
                "P4cf": 1312, 
                "P6cf": 1538, 
                "P3cf": 1269, 
                "P3mv": 1250
            }
        }
        self.vegafe = {
            "hex": "82020801005c0022070000032b00001b004800000080a90300f0490200power0008000000000000000000000000000002015c001b02120294006a01b400fe007a008c008801000000003e0200009000740239010f0163010071020071020202000000000000080000000000000005000700030005000000000000000108P0cvP1cvP2cvP3cvP4cvP5cvP6cvP7cv0101P3mv01018403000660ea0000004019010001dc4a010002007701000390910100046cb00100050008P0cf000000800000P1cf000100000000P2cf000200000000P3cf000300000000P4cf000400000000P5cf000500000000P6cf000600000000P7cf000700000000000360ea000000401901000080380100000008286e0000002cc9000001f80b0100028038010003905f010004f491010005d0b0010006c0d401000700086c39000000245e000001fc85000002acbc00000334d0000004686e0100050897010006eca30100070001683c0100000104P0mf00000000P1mf00010000P2mf00020000P3mf000300000108009885000078b4000060ea000050c300000180bb000060ea0000940b010050c300000278ff000040190100b427010050c3000003b4270100dc4a0100dc4a010050c3000004dc4a0100905f0100905f010050c300000500770100909101000077010050c3000006909101006cb001000077010050c30000076cb001006cb001009091010050c300000118000000000000000bsenFanfreeFandownFantempLine0a0054039001900190019001900190019001000000000002minFanmaxFan07dc00dc00dc002c01000059006900490049005f007300730064004000909297609600905500000000000000000000000000000000000202d4300000021060ea00000210",
            "defaults": {
                "P7cf": 1600, 
                "downFan": 2000, 
                "P5cf": 1440, 
                "tempLine": 80, 
                "P2cf": 1138, 
                "P4cf": 1348, 
                "P6cf": 1528, 
                "freeFan": 2000, 
                "P3cf": 1269
            }
        }
        self.vega64_water = {
            "hex": "9d020801005c0037070000ec2b00001b004800000080a90300f0490200power0008000000000000000000000000000002015c0036022d0294008501af0019017a008c00a301000000005902000090008f0254012a017e010071020071020202000000000000080000000000000004000700030005000000000000000108P0cvP1cvP2cvP3cvP4cvP5cvP6cvP7cv0101P3mv01018403000560ea000000dc4a010001007701000290910100036cb00100040108P0cf00000080000000000000P1cf00010000000000000000P2cf00020000000000000000P3cf00030000000000000000P4cf00040000000000000000P5cf00050000000001000000P6cf00060000000001000000P7cf00070000000001000000000360ea000000dc4a010000905f0100000008286e0000002cc9000001f80b0100028038010003905f010004f491010005d0b0010006c0d401000700086c39000000245e000001fc85000002acbc00000334d0000004686e0100050897010006eca30100070001683c0100000104P0mf00000000P1mf00000000P2mf00010000P3mf000200000108009885000078b4000060ea000050c300000178ff000040190100b427010050c300000280380100dc4a0100dc4a010050c3000003dc4a0100905f0100905f010050c3000004905f010000770100905f010050c30000050077010090910100905f010050c30000066cb001006cb001000077010050c3000007c0d40100c0d401009091010050c300000118000000000000000bsenFanfreeFandownFantempLine0f0054039001900190019001900190019001000000000002minFanmaxFan070801080108012c0100004a0069004a004a005f007300730064004000909297609600904600000000000000000000000000000000000202d4300000021060ea00000210",
            "defaults": {
                "P7cf": 1750, 
                "P1cf": 1138, 
                "downFan": 2300, 
                "P5cf": 1560, 
                "tempLine": 65, 
                "P2cf": 1302, 
                "P4cf": 1408, 
                "P6cf": 1668, 
                "freeFan": 1500, 
                "maxFan": 3300, 
                "P3cf": 1348
            }
        }
        self.vegafe_water = {
            "hex": "82020801005c00120700003d2b00001b004800000080a90300f0490200power0008000000000000000000000000000002015c001b02120294006a01b400fe007a008c008801000000003e0200009000740239010f0163010071020071020202000000000000080000000000000005000700030005000000000000000108P0cvP1cvP2cvP3cvP4cvP5cvP6cvP7cv0101P3mv01018403000660ea0000004019010001dc4a010002007701000390910100046cb00100050008P0cf000000800000P1cf000100000000P2cf000200000000P3cf000300000000P4cf000400000000P5cf000500000000P6cf000600000000P7cf000700000000000360ea000000401901000080380100000008286e0000002cc9000001f80b0100028038010003905f010004f491010005d0b0010006c0d401000700086c39000000245e000001fc85000002acbc00000334d0000004686e0100050897010006eca30100070001683c0100000104P0mf00000000P1mf00010000P2mf00020000P3mf000300000108009885000078b4000060ea000050c300000180bb000060ea0000940b010050c300000278ff000040190100b427010050c3000003b4270100dc4a0100dc4a010050c3000004dc4a0100905f0100905f010050c300000500770100909101000077010050c3000006909101006cb001000077010050c30000076cb001006cb001009091010050c300000118000000000000000bsenFanfreeFandownFantempLine0f0054039001900190019001900190019001000000000002minFanmaxFan070801080108012c0100004a0069004a004a005f007300730064004000909297609600904600000000000000000000000000000000000202d4300000021060ea00000210",
            "defaults": {
                "P7cf": 1600, 
                "downFan": 2300, 
                "P5cf": 1440, 
                "tempLine": 65, 
                "P2cf": 1138, 
                "P4cf": 1348, 
                "P6cf": 1528, 
                "freeFan": 1500, 
                "maxFan": 3300, 
                "P3cf": 1269
            }
        }
        self.wx8200 = {
            "hex": "A9020801005C00EB070000593000001B00400000000000000000000000power0008000000000000000000000000000002015C004002370294008F01B4001E017A008C00AD01000000006502000090009B025E0134018801F049020071020202000000000000080000000000000005000700030005000000000000000108P0cvP1cvP2cvP3cvP4cvP5cvP6cvP7cv0101P3mv01018403000660EA0000004019010001DC4A010002007701000390910100046CB00100060108P0cf00000080000000000000P1cf00010000000000000000P2cf00020000000000000000P3cf00030000000000000000P4cf00040000000000000000P5cf00050000000000000000P6cf00060000000000000000P7cf00070000000000000000000460EA0000004019010000DC4A010000905F0100000008286E0000002CC9000001F80B0100028038010003905F010004F491010005D0B0010006C0D401000700086C39000000245E000001FC85000002ACBC00000334D0000004686E0100050897010006ECA30100070001683C0100000104P0mf00000000P1mf00000000P2mf00010000P3mf000400000108009885000040B5000060EA000050C300000180BB000060EA0000940B010050C300000278FF000040190100B427010050C3000003B4270100DC4A0100DC4A010050C3000004DC4A0100905F0100905F010050C3000005905F010000770100905F010050C300000600770100909101000077010050C300000790910100909101000077010050C300000118000000000000000CsenFanfreeFandownFantempLine0A00540390019001900190019001900190010000000000020431minFanmaxFan07AA00AA00AA002C0100005B0069004A004A005F006400780064004000909297609600905500000000000000000000000000000000000202D4300000021060EA00000210",
            "defaults": {
                "P2mf": 700,
                "P5cf": 1399,
                "P4cf": 1348,
                "tempLine": 80,
                "Dev": 8200,
                "downFan": 2200,
                "freeFan": 2000,
                "P3cf": 1269,
                "P3mf": 1000,
                "maxFan": 3400,
                "P7cf": 1500,
                "P6cf": 1440,
                "P2cf": 1138,
                "power": 0,
                "minFan": 1100
            }
        }
        self.wx9100 = {
            "hex": "A2020801005C0086070000D92C00001B00480000000000000000000000power0008000000000000000000000000000002015C003B02320294008A01B4001E017A008C00A801000000005E0200009000940259012F018301F049020071020202000000000000080000000000000005000700030005000000000000000108P0cvP1cvP2cvP3cvP4cvP5cvP6cvP7cv0101P3mv01018403000660EA0000004019010001DC4A010002007701000390910100046CB00100060108P0cf00000080000000000000P1cf00010000000000000000P2cf00020000000000000000P3cf00030000000000000000P4cf00040000000000000000P5cf00050000000000000000P6cf00060000000000000000P7cf00070000000000000000000360EA000000401901000080380100000008286E0000002CC9000001F80B0100028038010003905F010004F491010005D0B0010006C0D401000700086C39000000245E000001FC85000002ACBC00000334D0000004686E0100050897010006ECA30100070001683C0100000104P0mf00000000P1mf00000000P2mf00020000P3mf000300000108009885000040B5000060EA000050C300000180BB000060EA0000940B010050C300000278FF000040190100B427010050C3000003B4270100DC4A0100DC4A010050C3000004DC4A0100905F0100905F010050C3000005905F010000770100905F010050C300000600770100909101000077010050C300000790910100909101000077010050C300000118000000000000000BsenFanfreeFandownFantempLine0A0054039001900190019001900190019001000000000002minFanmaxFan07AA00AA00AA002C0100005B0069004A004A005F006400780064004000909297609600905500000000000000000000000000000000000202D4300000021060EA00000210",
            "defaults": {
                "power": 0,
                "P7cf": 1500,
                "P5cf": 1399,
                "P4cf": 1348,
                "P6cf": 1440,
                "tempLine": 80,
                "P2cf": 1138,
                "Dev": 9100,
                "downFan": 2000,
                "freeFan": 2000,
                "P3cf": 1269
            }
        }
        self.types = {
            "vega64":"Vega 64",
            "vega56":"Vega 56",
            "vegafe":"Vega FE",
            "vega64_water":"Vega 64 Liquid Cooled",
            "vegafe_water":"Vega FE Liquid Cooled",
            "wx8200":"Radeon Pro WX 8200",
            "wx9100":"Radeon Pro WX 9100"
        }
        self.times = [ # Hex length = 6
            "cf",
            "mf"
        ]
        self.divide = [ # Hex length = 2
            "minFan",
            "maxFan"
        ]
        self.minpad = [
            "power"
        ]
        self.selected = {}

    def compare_defaults(self, t = None, **kwargs):
        # Takes a base64, hex, or ascii string, converts it to ascii if needed, walks each line, splitting by = and
        # compares the values to the vega64, creating a dict of defaults that differ.
        if not t:
            return
        d = kwargs.get("data_type","b").lower() # a = ascii, b = base64, h = hex
        o = kwargs.get("output_type","json").lower() # json or dict
        if d == "b":
            t_ascii = base64.b64decode(t.encode("utf-8")).decode("utf-8")
        elif d == "h":
            t_ascii = binascii.unhexlify(t.encode("utf-8")).decode("utf-8")
        else:
            # Assume ascii
            t_ascii = t
        defaults = {}
        for x in t_ascii.split("\n"):
            try:
                y,z = x.split("=")
                z = int(z)
            except:
                continue
            # Compare to the vega64
            a = self.vega64["defaults"].get(y,None)
            if z != a:
                # they differ - add it
                defaults[y] = z
        if o == "dict":
            return defaults
        else:
            # assume json
            return json.dumps(defaults,indent=2)

    def select_type(self, t = None):
        if t == None:
            t = "vega64"
        if not hasattr(self,t):
            return None
        selected = getattr(self,t)
        self.selected = {"hex":selected["hex"]}
        self.selected["defaults"] = {}
        for x in self.vega64["defaults"]:
            self.selected["defaults"][x] = selected["defaults"].get(x,self.vega64["defaults"].get(x,None))
        return self.selected

    def dump_hex(self):
        if not self.selected:
            return None
        temp_hex = self.selected["hex"]
        temp_d   = self.selected["defaults"]
        for x in temp_d:
            v = int(temp_d[x])
            l = 4
            if any(y for y in self.times if x.endswith(y)):
                l  = 6
                v *= 100
            if any(y for y in self.divide if x.endswith(y)):
                v /= 100
                l  = 2
            if any(y for y in self.minpad if x.endswith(y)):
                l  = 2
            # Get the actual value pad the hex, swap pairs - then replace our entry in the hex
            hex_str = "{:x}".format(int(v))
            hex_str = "0"*(l-len(hex_str))+hex_str
            hex_str = list("0"*(len(hex_str)%2)+hex_str)
            hex_pairs = [hex_str[i:i + 2] for i in range(0, len(hex_str), 2)]
            hex_rev = hex_pairs[::-1]
            hex_str = "".join(["".join(z) for z in hex_rev])
            temp_hex = temp_hex.replace(x, hex_str)
        return temp_hex
